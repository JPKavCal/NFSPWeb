{% extends 'base.html' %}
{% load leaflet_tags %}
{% load static %}

{% block title %}- K5/2748 DFE{% endblock %}

{% block header %}
    {% leaflet_js %}
    {% leaflet_css %}
    <link rel="stylesheet" href="{% static 'gaugedata/MarkerCluster.css' %}" />
    <link rel="stylesheet" href="{% static 'gaugedata/MarkerCluster.Default.css' %}" />
    <script src="{% static 'gaugedata/leaflet.markercluster-src.js' %}"></script>
    <script src="{% static 'gaugedata/leaflet.spin.min.js' %}"></script>
    <script src="{% static 'gaugedata/spin.js' %}"></script>
{% endblock %}

{% block body_block %}

    <div class="row mx-0">
        <div class="col-md-6 jumbotron py-4 mb-0">
          <h1 class="jumbotron-heading">Design Flood Estimation</h1>
          <p class="lead text-muted">To be completed...</p>
            <form method="POST">
            {% csrf_token %}

            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">Select Station</span>
              </div>
              <select class="rounded-0" id="station_dd">
                    <option value=""></option>
                {% for gauge in gauges %}
                    <option value="{{ gauge.pk }}">{{ gauge.pk }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text">Lat</span>
              </div>
              <input type="text" class="form-control" id="Lat" readonly>
              <div class="input-group-append">
                <span class="input-group-text">Lon</span>
              </div>
              <input type="text" class="form-control" id="Lon" readonly>
            </div>


            </form>
        </div>
        <div class="col-md-6 p-0">
            {% leaflet_map "dfe_map" callback="map_init_basic" %}
        </div>
    </div>

<div>

  <ul class="nav nav-pills nav-justified">
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0 active" href="#catch_param" aria-controls="catch_param" role="tab" data-toggle="tab">Parameters</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#RM" aria-controls="RM" role="tab" data-toggle="tab">RM</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#ARM" aria-controls="ARM" role="tab" data-toggle="tab">ARM</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#SDF" aria-controls="SDF" role="tab" data-toggle="tab">SDF</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#SCS" aria-controls="SCS" role="tab" data-toggle="tab">SCS</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#EMP" aria-controls="EMP" role="tab" data-toggle="tab">EMP</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#UH" aria-controls="UH" role="tab" data-toggle="tab">UH</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#Stats" aria-controls="Stats" role="tab" data-toggle="tab">Stats</a></li>
    <li role="presentation" class="nav-item"><a class="nav-link rounded-0" href="#Results" aria-controls="Results" role="tab" data-toggle="tab">Results</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="catch_param">
      Info Here
      <p>Insert option for automatic calculation...</p>

      <table>
{#        {{catchment_data_form.as_table}}#}
      </table>


    </div>
    <div role="tabpanel" class="tab-pane" id="RM">
      Rational Method

      <table>
{#        {{rm_form}}#}
      </table>

    </div>
    <div role="tabpanel" class="tab-pane" id="ARM">Alternative RM</div>
    <div role="tabpanel" class="tab-pane" id="SDF">SDF method</div>
    <div role="tabpanel" class="tab-pane" id="SCS">SCS method</div>
    <div role="tabpanel" class="tab-pane" id="EMP">Empirical methods</div>
    <div role="tabpanel" class="tab-pane" id="UH">Unit Hydrograph</div>
    <div role="tabpanel" class="tab-pane" id="Stats">Statistical analysis here</div>
    <div role="tabpanel" class="tab-pane" id="Results">Output results here</div>
  </div>

</div>

{% endblock %}

{% block scriptblock %}
    <script>

        var mapsPlaceholder = [];
        var markersHolder = [];
        var polyHolder = [];

        function getStationData() {
            mapsPlaceholder[0].spin(true);
            $.ajax({
                headers: {"X-CSRFToken": getCookie('csrftoken')},
                method: "POST",
                url:'{% url "gaugedata:gauged" %}',
                data: { 'station': $("#station_dd").val()},
                success: function(data) {
                    $("#Lat").val(data.lat);
                    $("#Lon").val(data.lon);
                    if (data.lat != 0) {
                        if (markersHolder.length == 1) {
                            var m = markersHolder.pop();
                            m.remove();
                        }
                        var marker = L.marker([data.lat, data.lon]).addTo(mapsPlaceholder[0]);
                        markersHolder.push(marker);
                        mapsPlaceholder[0].setView([data.lat, data.lon], 8);
                    }
                    if (data.poly[0][0] != 0) {
                        if (polyHolder.length == 1) {
                            var p = polyHolder.pop();
                            p.remove();
                        }
                        var poly = L.polygon(data.poly, {color: 'green'}).addTo(mapsPlaceholder[0]);
                        polyHolder.push(poly);
                        mapsPlaceholder[0].fitBounds(poly.getBounds());
                    }
                }
            }).done(function () {
                mapsPlaceholder[0].spin(false);
            })
        }

        function map_init_basic (map, options) {
            {#map.dragging.disable();#}
            {#map.touchZoom.disable();#}
            {#map.doubleClickZoom.disable();#}
            {#map.scrollWheelZoom.disable();#}
            {#map.zoomControl.remove();#}
            map.resetviewControl.remove();
            mapsPlaceholder.push(map);
        }

        $(document).ready(function(){
            $("#station_dd").val("{{ name }}");
            getStationData();
        });

        $("#station_dd").change(function() {
            getStationData();
        });

    </script>
{% endblock %}
